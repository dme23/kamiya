<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="Static/css/LandinPage.css">
    <title>CRUD</title>
    
  </head>
  <body>
    
    <header class="header" style="position: absolute;">
      <div class="container logo-nav-container">
      <a href="#" class="logo" style="color: rgb(34, 199, 163);"><strong>K-miya</strong></a>
      <nav class="navigation">
          <ul>
          <li><a href="pagina1.html"><strong>Inicio</strong></a></li>
          <li><a href="crud.html"><strong>Clinicas</strong></a></li>
          <li><a href="crudDoctores.html"><strong>Doctores</strong></a></li>
          <li><a href="#"><strong>Usuarios</strong></a></li>
          <li><a href="#" id="cerrar"><strong>Cerrar Sesion</strong></a></li>
          </ul>
      </nav>
      </div>
  </header>
  <main>
      <div class="container" style="padding-top: 7%" > 
        <H1 style="text-align: center">Base de Datos Clinicas</H1> <br>
        <p>En esta tabla encontraras toda la información de las clinicas, las cuales podras manipular segun los cambios que se hayan realizado en las mismas.<br> <br>
          <strong>!Cuidado!</strong> La mala manipulación de los datos podria generar conflictos en la pagina
        </p>
        <div class="row" >
          <div class="col-lg-6">
              <button id="btnNuevo" Style="background-color: rgb(23, 109, 90); border-color: white;" class="btn btn-primary" data-toggle="tooltip" title="Añadir Clínica"><svg class="bi bi-plus-circle-fill" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4a.5.5 0 0 0-1 0v3.5H4a.5.5 0 0 0 0 1h3.5V12a.5.5 0 0 0 1 0V8.5H12a.5.5 0 0 0 0-1H8.5V4z"/></svg></button>
                <!--Modal-->
                  <div id="modalAltaEdicion" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                      <div class="modal-dialog" role="document">
                          <div class="modal-content">
                              <div class="modal-header bg-primary text-light" style="background-color:  rgb(34, 199, 163)">
                                  <h5 class="modal-title" id="exampleModalLabel">Registro de Clínica</h5>
                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                                  </button>
                              </div>
                                  <form>
                                  <div class="modal-body">
                                      <input id="id" type="hidden"> <!-- ID que vamos a recibir de firebase -->
                                      <div class="form-group">                                    
                                        <label>NOMBRE</label>
                                        <input id="nombre" type="text" class="form-control" required>
                                      </div>    
                                      <div class="form-group">
                                        <label>DIRECCIÓN</label>
                                        <input id="direccion" type="text" class="form-control" required>
                                      </div>
                                      <div class="form-group especialidades">
                                        <label>ESPECIALIDADES</label>
                                        <input id="especialidades" class="form-control" required>
                                      </div>
                                      <button type="button" class="add-especialidad">Añadir especialidad</button>
                                  </div>
                                  <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-dismiss="modal" tabindex="2">Cancelar</button>
                                      <button type="submit" id="btnGuardar" class="btn btn-primary" translate="1">Guardar</button>
                                  </div>
                                 </form>
                      </div>
                  </div>
                  </div>
                <table id="tablaClinicas" class="table table-bordered">
                  <thead>
                    <tr class="bg-dark text-light">
                      <th scope="col" style="padding-right: 150px; background-color:  rgb(34, 199, 163);">NOMBRE</th>
                      <th scope="col" style="padding-right: 200px; background-color:  rgb(34, 199, 163)">DIRECCIÓN</th>
                      <th scope="col" style="background-color:  rgb(34, 199, 163)">ESPECIALIDADES</th>
                      <th scope="col" style="background-color:  rgb(34, 199, 163)">DOCTORES</th>
                      <th scope="col" style=" background-color:  rgb(34, 199, 163)">ACCIONES</th>

                    </tr>
                  </thead>
                <tbody id="bodyClinicas">
                </tbody>
                </table>
          </div>
        </div>
      </div>
    </div>
    </main>
      <footer class="footer" style="margin-top: 101px; background-color:  rgb(34, 199, 163)">
        <div class="container">
            <h1 style="color: white;">¡El mejor aliado para tu salud!</h1>
        </div>
    </footer>
   



    <!-- Optional JavaScript; choose one of the two! -->
    
    <!-- Option 1: jQuery and Bootstrap Bundle (includes Popper) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.9.0/dist/sweetalert2.all.min.js"></script>
    <!-- Option 2: jQuery, Popper.js, and Bootstrap JS
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
    -->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase.js"></script>

  
  <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-analytics.js"></script>
  
  <script>
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  var firebaseConfig = {
    apiKey: "AIzaSyDAWoHlWSmyLAHxCkgeYNX1NDyi4aSILaI",
    authDomain: "usuarios-6b419.firebaseapp.com",
    databaseURL: "https://usuarios-6b419.firebaseio.com",
    projectId: "usuarios-6b419",
    storageBucket: "usuarios-6b419.appspot.com",
    messagingSenderId: "763350583227",
    appId: "1:763350583227:web:4de618687bc41f02dfa69e",
    measurementId: "G-CSVYH613NR"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  firebase.auth();
  
  const db = firebase.database();
  coleccionClinicas = db.ref().child('clinicas');
  coleccionDoctores = db.ref().child('doctores');
  bodyClinicas = $('#bodyClinicas').val();
  //console.log(bodyClinicas);
  
  const signOutBtn = document.querySelector('#cerrar');

  signOutBtn.addEventListener("click", () => {
  firebase.auth().signOut().then(() => document.location.href= "iniciar_Sesion.html");
  });

   
  $('form').submit(function(e){
    e.preventDefault();
    let id = $('#id').val();
    let nombre = $('#nombre').val();
    let direccion = $('#direccion').val();
    let especialidades = [];
    document.querySelector('.especialidades').querySelectorAll('input').forEach(input => {
      if (input.value) especialidades.push(input.value);
    });
    let idFirebase = id;
    if(idFirebase == ''){
     idFirebase = coleccionClinicas.push().key;
    };
    data ={nombre:nombre, direccion:direccion, especialidades:especialidades}

    actualizacionData = {};

    actualizacionData[`/${idFirebase}`] = data;

    coleccionClinicas.update(actualizacionData);
    id = '';
    $('form').trigger('reset');
    $('#modalAltaEdicion').modal('hide');
  });

  const iconoEditar = '<svg class="bi bi-pencil-square" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456l-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>';
  const iconoBorrar = '<svg class="bi bi-trash" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>';

  function mostrarProductos({nombre, direccion, especialidades, doctors}){
    return `
    <td>${nombre}</td>
    <td>${direccion}</td>
    <td>
      ${especialidades.reduce((acc, current) => acc + ', ' + current)}
    </td>
    <td>
      ${(doctors.length > 0) ? doctors.reduce((acc, current) => acc + ', ' + current) : ''}
    </td>
    <td><button class="btnEditar btn btn-secondary" data-toggle="tooltip" title="Editar">${iconoEditar}</button><button class="btnBorrar btn btn-danger" data-toggle="tooltip" title="Borrar">${iconoBorrar}</button></td>
    `
  };

  $(".add-especialidad").click(() => $('.especialidades').append('<input class="form-control">'));

  //Programacion botones
  $('#btnNuevo').click(function(){
    $('#id').val('');
    $('#nombre').val('');
    $('#direccion').val('');

    document.querySelector(".especialidades")
    .querySelectorAll('input')
    .forEach((element, index) => { if (index != 0) element.remove() })

    $('form').trigger('reset');
    $('#modalAltaEdicion').modal('show');
  });

  $('#tablaClinicas').on('click', '.btnEditar', function(){
    let id = $(this).closest('tr').attr('id');
    let nombre = $(this).closest('tr').find('td:eq(0)').text();
    let direccion = $(this).closest('tr').find('td:eq(1)').text();
    let especialidades = $(this).closest('tr').find('td:eq(2)').text().trim().split(',');
    $('#id').val(id);
    $('#nombre').val(nombre);
    $('#direccion').val(direccion);

    document.querySelector(".especialidades")
    .querySelectorAll('input')
    .forEach(element => element.remove())

    especialidades.forEach(especialidad => {
      let input = document.createElement('input');
      input.classList.add('form-control');
      input.value = especialidad;
      $('.especialidades').append(input)
    })         
    $('#modalAltaEdicion').modal('show');
  });

  $('#tablaClinicas').on('click', '.btnBorrar', function(){
      Swal.fire({
        title: '¿Está seguro de eliminar la Clínica',
        text: "¡Está operación no se puede revertir!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Borrar'
        }).then((result) => {
        if (result.value) {
            let id = $(this).closest('tr').attr('id'); //capturamos el atributo ID de la fila  
            db.ref(`clinicas/${id}`).remove() //eliminamos la clinica de firebase
            coleccionDoctores.orderByChild("clinica/id").equalTo(id).once('value').then(snapshot => {
              snapshot.forEach(snap => {
                let obj = snap.val();
                obj.clinica = {};
                console.log(obj);
                snap.ref.update(obj);
              })
            });
            Swal.fire('¡Eliminado!', 'La Clínica ha sido eliminada.','success')
        }
        })        
  });

// CHILD_ADDED
coleccionClinicas.on('child_added', data => {
    let tr = document.createElement('tr')
    tr.id = data.key
    console.log(data.key)
    coleccionDoctores.orderByChild("clinica/id").equalTo(data.key).once('value').then(snapshot => {
      console.log(snapshot.val())
      let doctors = [];
      let especialidades = [];
      if (snapshot.val()) {
        Object.values(snapshot.val()).forEach(el => {
          doctors.push(`${el.nombre} ${el.apellido}`);
          especialidades.push(el.especialidad);
        })

      }
      tr.innerHTML = mostrarProductos({...data.val(), especialidades, doctors})
      document.getElementById('bodyClinicas').appendChild(tr)
    })

  });
  //CHILD_CHANGED
  coleccionClinicas.on('child_changed', data =>{
    let nodoEditado = document.getElementById(data.key)
    nodoEditado.innerHTML = mostrarProductos(data.val())
  });
  //CHILD_REMOVED
  coleccionClinicas.on('child_removed', data =>{
    let nodoEditado = document.getElementById(data.key)
    document.getElementById('bodyClinicas').removeChild(nodoEditado)
  });

  </script>
  

  </body>
</html> 